// This is your Prisma schema file
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  OPERATOR
  PRINTER
  FIELD
}

enum PoleStatus {
  AVAILABLE
  OCCUPIED
  MAINTENANCE
  INACTIVE
}

enum OrderStatus {
  PENDING
  SCHEDULED
  PRINTING
  AWAITING_MOUNT
  LIVE
  EXPIRED
  COMPLETED
  CANCELLED
}

enum FileType {
  CONTRACT
  AD_IMAGE
  PROOF_MOUNT
  PROOF_DISMOUNT
}

model User {
  id                 String   @id @default(uuid()) @db.Uuid
  email              String   @unique
  password           String
  role               UserRole
  name               String
  phone              String?
  active             Boolean  @default(true)
  emailNotifications Boolean  @default(true) @map("email_notifications")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  createdOrders     Order[]                      @relation("CreatedOrders")
  printerOrders     Order[]                      @relation("PrinterOrders")
  fieldOrders       Order[]                      @relation("FieldOrders")
  workflowChanges   WorkflowHistory[]
  uploadedFiles     File[]
  notificationLogs  NotificationLog[]
  passwordResetTokens PasswordResetToken[]
  notificationPrefs  UserNotificationPreferences?
  pricingHistory    PricingHistory[]
  pricingUpdates    PricingConfig[]

  @@index([role])
  @@index([email])
  @@map("users")
}

model Pole {
  id           String     @id @default(uuid()) @db.Uuid
  poleCode     String     @unique @map("pole_code")
  latitude     Float
  longitude    Float
  city         String?
  district     String?
  neighborhood String?
  street       String?
  sequenceNo   Int?       @map("sequence_no")
  status       PoleStatus @default(AVAILABLE)
  deletedAt    DateTime?  @map("deleted_at")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  // Relations
  orders Order[]

  @@index([status])
  @@index([poleCode])
  @@index([deletedAt])
  @@map("poles")
}

model Order {
  id              String      @id @default(uuid()) @db.Uuid
  poleId          String      @map("pole_id") @db.Uuid
  clientName      String      @map("client_name")
  clientContact   String?     @map("client_contact")
  startDate       DateTime    @map("start_date") @db.Date
  endDate         DateTime    @map("end_date") @db.Date
  status          OrderStatus @default(PENDING)
  contractFileUrl String?     @map("contract_file_url")
  adImageUrl      String?     @map("ad_image_url")
  createdById     String      @map("created_by") @db.Uuid
  assignedPrinter String?     @map("assigned_printer") @db.Uuid
  assignedField   String?     @map("assigned_field") @db.Uuid
  cancelledAt     DateTime?   @map("cancelled_at")
  cancelledBy     String?     @map("cancelled_by") @db.Uuid
  cancellationReason String?  @map("cancellation_reason")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  pole            Pole              @relation(fields: [poleId], references: [id], onDelete: Restrict)
  createdBy       User              @relation("CreatedOrders", fields: [createdById], references: [id])
  printer         User?             @relation("PrinterOrders", fields: [assignedPrinter], references: [id])
  field           User?             @relation("FieldOrders", fields: [assignedField], references: [id])
  workflowHistory WorkflowHistory[]
  files           File[]

  @@index([poleId])
  @@index([status])
  @@index([startDate, endDate])
  @@index([assignedPrinter])
  @@index([assignedField])
  @@index([cancelledAt])
  @@map("orders")
}

model WorkflowHistory {
  id        String      @id @default(uuid()) @db.Uuid
  orderId   String      @map("order_id") @db.Uuid
  oldStatus OrderStatus? @map("old_status")
  newStatus OrderStatus @map("new_status")
  changedBy String      @map("changed_by") @db.Uuid
  notes     String?
  isRollback Boolean   @default(false) @map("is_rollback")
  timestamp DateTime    @default(now())

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [changedBy], references: [id])

  @@index([orderId])
  @@index([timestamp(sort: Desc)])
  @@map("workflow_history")
}

model PricingConfig {
  id        String   @id @default(uuid()) @db.Uuid
  key       String   @unique
  value     Decimal  @db.Decimal(10, 2)
  unit      String? // 'TL', '%'
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy String?  @map("updated_by") @db.Uuid

  // Relations
  user   User?             @relation(fields: [updatedBy], references: [id])
  history PricingHistory[]

  @@map("pricing_config")
}

model PricingHistory {
  id           String   @id @default(uuid()) @db.Uuid
  pricingKey   String   @map("pricing_key")
  oldValue     Decimal  @db.Decimal(10, 2) @map("old_value")
  newValue     Decimal  @db.Decimal(10, 2) @map("new_value")
  unit         String?
  changedBy    String   @map("changed_by") @db.Uuid
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  pricingConfig PricingConfig @relation(fields: [pricingKey], references: [key])
  user          User          @relation(fields: [changedBy], references: [id])

  @@index([pricingKey])
  @@index([createdAt(sort: Desc)])
  @@map("pricing_history")
}

model File {
  id           String   @id @default(uuid()) @db.Uuid
  orderId      String   @map("order_id") @db.Uuid
  fileType     FileType @map("file_type")
  fileUrl      String   @map("file_url")
  thumbnailUrl String?  @map("thumbnail_url")
  originalName String?  @map("original_name")
  fileSize     Int?     @map("file_size")
  uploadedBy   String   @map("uploaded_by") @db.Uuid
  deletedAt    DateTime? @map("deleted_at")
  uploadedAt   DateTime @default(now()) @map("uploaded_at")

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [uploadedBy], references: [id])

  @@index([orderId])
  @@index([fileType])
  @@index([deletedAt])
  @@map("files")
}

model PasswordResetToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("password_reset_tokens")
}

model NotificationLog {
  id           String    @id @default(uuid()) @db.Uuid
  userId       String    @map("user_id") @db.Uuid
  orderId      String?   @map("order_id") @db.Uuid
  type         String    // 'EMAIL', 'SMS'
  template     String    // Template name
  subject      String?
  content      String?   @db.Text
  status       String    // 'SENT', 'FAILED', 'PENDING'
  errorMessage String?   @map("error_message") @db.Text
  retryCount   Int       @default(0) @map("retry_count")
  sentAt       DateTime? @map("sent_at")
  createdAt    DateTime  @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("notification_logs")
}

model UserNotificationPreferences {
  id                 String   @id @default(uuid()) @db.Uuid
  userId             String   @unique @map("user_id") @db.Uuid
  emailEnabled       Boolean  @default(true) @map("email_enabled")
  newOrderEnabled    Boolean  @default(true) @map("new_order_enabled")
  statusChangeEnabled Boolean @default(true) @map("status_change_enabled")
  assignmentEnabled  Boolean  @default(true) @map("assignment_enabled")
  reminderEnabled    Boolean  @default(true) @map("reminder_enabled")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_notification_preferences")
}

model LoginAttempt {
  id        String   @id @default(uuid()) @db.Uuid
  email     String
  ipAddress String   @map("ip_address")
  success   Boolean
  createdAt DateTime @default(now()) @map("created_at")

  @@index([email])
  @@index([ipAddress])
  @@index([createdAt])
  @@map("login_attempts")
}

model Report {
  id           String   @id @default(uuid()) @db.Uuid
  type         String   // 'PRINTER', 'FIELD', 'FINANCIAL'
  title        String
  fileUrl      String   @map("file_url")
  fileType     String   @map("file_type") // 'PDF', 'EXCEL', 'CSV'
  startDate    DateTime @map("start_date")
  endDate      DateTime @map("end_date")
  generatedBy  String   @map("generated_by") @db.Uuid
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([type])
  @@index([generatedBy])
  @@index([createdAt(sort: Desc)])
  @@map("reports")
}
